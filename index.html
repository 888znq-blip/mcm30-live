<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
import { getDatabase, ref, get } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";

const firebaseConfig = {
  apiKey: "AIzaSyDrvNy94Jhq8RmYM7jgfckrxneCetVkYw4",
  authDomain: "mcm30-db-fe9da.firebaseapp.com",
  databaseURL: "https://mcm30-db-fe9da-default-rtdb.asia-southeast1.firebasedatabase.app",
  projectId: "mcm30-db-fe9da",
  storageBucket: "mcm30-db-fe9da.firebasestorage.app",
  messagingSenderId: "34034835036",
  appId: "1:34034835036:web:3e5dcd7e6b5c2c21e15099"
};

const app = initializeApp(firebaseConfig);
const db = getDatabase(app);

const canvas=document.getElementById('matrixCanvas');
const ctx=canvas.getContext('2d',{alpha:false,desynchronized:true});
const statusEl=document.getElementById('status');
const DERIV_WS="wss://ws.derivws.com/websockets/v3?app_id=1089";
const TOKEN="TpVIBWpqet5X8AH";
const SYMBOL="frxEURUSD"; 
let ws=null,subscriptionId=null,lastPrice=null,currentColumn=0,ticksInCurrentMinute=0;
let matrixData={};
let cameraX=0,isFollowing=true,isDragging=false,lastMouseX=0;
let pulsingRows=new Set(); // FEATURE 1: Track rows to pulse
const CELL_W=32;
let CELL_H=12;
const MARGIN_LEFT=35;
const MARGIN_RIGHT=145;
const MARGIN_BOTTOM=22;
const MAX_COLS=14400;
const TOTAL_ROWS=30;
const MCM_LOOKBACK=30;
const pad=(n,size=2)=>String(n).padStart(size,'0');

let tickHistory=[];

async function loadFirebaseData() {
    statusEl.innerText = "LOADING DB...";
    try {
        const snapshot = await get(ref(db, 'tick_history'));
        if (snapshot.exists()) {
            const data = snapshot.val();
            if (data.prices && data.times) {
                matrixData = {}; currentColumn = 0; ticksInCurrentMinute = 0; tickHistory = [];
                for(let i = 0; i < data.prices.length; i++) {
                    handleTick({ quote: data.prices[i], epoch: data.times[i] });
                }
                statusEl.innerText = "DB SYNCED";
                updateStreakPanel();
                updateReversalPanel();
                if(isFollowing) jumpToCurrent();
            }
        }
    } catch (e) { statusEl.innerText = "DB ERROR"; }
}

function connectDerivWS(){
    ws=new WebSocket(DERIV_WS);
    ws.onopen=()=>ws.send(JSON.stringify({authorize:TOKEN}));
    ws.onmessage=(msg)=>{
        const data=JSON.parse(msg.data);
        if(data.authorize){ statusEl.innerText="LIVE"; ws.send(JSON.stringify({ticks:SYMBOL,subscribe:1})); }
        if(data.tick) handleTick(data.tick);
    };
    ws.onclose=()=>setTimeout(connectDerivWS,3000);
}

// FEATURE 1: Anomaly Detection Logic
function detectPulsingRows() {
    pulsingRows.clear();
    let allPatterns = [];
    for (let row = 0; row < TOTAL_ROWS; row++) {
        let rS = {}, gS = {};
        Object.keys(matrixData).forEach(col => {
            const d = matrixData[col][row];
            if (d) {
                const map = d.c === 'R' ? rS : gS;
                if (!map[d.s]) map[d.s] = [];
                map[d.s].push(col);
            }
        });
        [rS, gS].forEach((map, i) => {
            const color = i === 0 ? 'R' : 'G';
            Object.keys(map).forEach(s => {
                const streak = parseInt(s), freq = map[s].length;
                allPatterns.push({ row, streak, freq, score: streak * (100 / freq), color });
            });
        });
    }
    allPatterns.sort((a, b) => b.score - a.score);
    const top10 = allPatterns.slice(0, 10);
    const currentCols = Object.keys(matrixData).map(Number);
    const liveCol = currentCols.length > 0 ? Math.max(...currentCols) : -1;

    top10.forEach(p => {
        if (liveCol < 0 || !matrixData[liveCol]) return;
        const live = matrixData[liveCol][p.row];
        if (live) {
            if (live.c !== p.color && live.s >= p.streak - 2) pulsingRows.add(p.row);
            if (live.c === p.color && live.s >= p.streak - 1 && live.s <= p.streak + 1) pulsingRows.add(p.row);
        }
    });
}

function handleTick(tick){
    const price=tick.quote;
    const timestamp=tick.epoch*1000;
    tickHistory.push({price,timestamp});
    if(!matrixData[currentColumn]) matrixData[currentColumn]={};
    const row=Math.min(ticksInCurrentMinute,TOTAL_ROWS-1);
    
    let color=null;
    if(tickHistory.length>=MCM_LOOKBACK+1){
        const oldP = tickHistory[tickHistory.length-(MCM_LOOKBACK+1)].price;
        color = price > oldP ? 'G' : (price < oldP ? 'R' : 'G');
    } else color='G';

    if(currentColumn>0&&matrixData[currentColumn-1]&&matrixData[currentColumn-1][row]){
        const prev=matrixData[currentColumn-1][row];
        matrixData[currentColumn][row]={c:color,s:prev.c===color?prev.s+1:1};
    } else matrixData[currentColumn][row]={c:color,s:1};

    ticksInCurrentMinute++;
    if(ticksInCurrentMinute>=TOTAL_ROWS){
        currentColumn++;
        if(currentColumn>=MAX_COLS) currentColumn=0;
        ticksInCurrentMinute=0;
    }
    updateStreakPanel();
    updateReversalPanel();
    detectPulsingRows(); // Update anomalies every tick
    if(isFollowing) jumpToCurrent();
}

function resize(){
    const dpr=window.devicePixelRatio||1;
    canvas.width=window.innerWidth*dpr;
    canvas.height=(window.innerHeight-42)*dpr;
    canvas.style.width=window.innerWidth+'px';
    canvas.style.height=(window.innerHeight-42)+'px';
    ctx.scale(dpr,dpr);
    CELL_H=(window.innerHeight-42-MARGIN_BOTTOM)/TOTAL_ROWS;
    if(isFollowing)jumpToCurrent();
}

function jumpToCurrent(){
    const cols=Object.keys(matrixData).map(Number);
    if(cols.length===0)return;
    const lastCol=Math.max(...cols);
    cameraX=Math.max(0,(lastCol*CELL_W)-(window.innerWidth-MARGIN_RIGHT-MARGIN_LEFT-CELL_W));
}

function updateStreakPanel(){
    const panel=document.getElementById('streakPanel');
    const indexPanel=document.getElementById('indexPanel');
    let html='', indexHtml='';
    for(let s=0;s<TOTAL_ROWS;s++){
        let rM=0,gM=0;
        Object.values(matrixData).forEach(m=>{
            if(m[s]){if(m[s].c==='R')rM=Math.max(rM,m[s].s); else gM=Math.max(gM,m[s].s);}
        });
        html+=`<div class="streak-row" onclick="window.openModal(${s})" style="position:absolute;top:${s*CELL_H}px;height:${CELL_H}px">
        <div class="streak-col red-side">${rM?'x'+pad(rM,2):'--'}</div>
        <div class="streak-col green-side">${gM?'x'+pad(gM,2):'--'}</div></div>`;
        
        // Apply Pulsing Class to Index Panel
        const pulseClass = pulsingRows.has(s) ? 'pulsing' : '';
        indexHtml+=`<div class="index-cell ${pulseClass}" style="top:${s*CELL_H}px;height:${CELL_H}px">${pad(s,2)}</div>`;
    }
    panel.innerHTML=html;
    indexPanel.innerHTML=indexHtml;
}

function updateReversalPanel(){
    const panel=document.getElementById('reversalPanel');
    let redMap={}, greenMap={};
    for(let row=0;row<TOTAL_ROWS;row++){
        let rS={}, gS={};
        Object.keys(matrixData).forEach(colKey=>{
            const d=matrixData[colKey][row];
            if(d){if(d.c==='R'){if(!rS[d.s])rS[d.s]=[]; rS[d.s].push(colKey);} else {if(!gS[d.s])gS[d.s]=[]; gS[d.s].push(colKey);}}
        });
        [ {m:redMap, s:rS}, {m:greenMap, s:gS} ].forEach(cfg=>{
            const nums=Object.keys(cfg.s).map(Number).sort((a,b)=>b-a);
            if(nums.length>0){
                const b=nums[0], p=cfg.s[b], f=p.length, k=`X${pad(b,2)}-${pad(f,2)}T`;
                if(!cfg.m[k]) cfg.m[k]={streak:b,freq:f,rows:[],score:b*(100/f)};
                cfg.m[k].rows.push({row:row,lastCol:Math.max(...p)});
            }});
    }
    const rE=Object.keys(redMap).map(k=>({k,d:redMap[k]})).sort((a,b)=>b.d.score-a.d.score);
    const gE=Object.keys(greenMap).map(k=>({k,d:greenMap[k]})).sort((a,b)=>b.d.score-a.d.score);
    let html='';
    for(let i=0;i<Math.max(rE.length,gE.length,1);i++){
        html+=`<div class="reversal-row" style="position:absolute;top:${i*CELL_H}px;height:${CELL_H}px">`;
        [ {e:rE[i], c:'red'}, {e:gE[i], c:'green'} ].forEach(side=>{
            if(side.e){
                const d=JSON.stringify(side.e.d.rows).replace(/"/g,'&quot;');
                html+=`<div class="reversal-col ${side.c}-side" onclick="window.openReversalModal('${side.e.k}',${d},'${side.c}')">${side.e.k}</div>`;
            }else html+=`<div class="reversal-col ${side.c}-side">--</div>`;
        });
        html+='</div>';
    }
    panel.innerHTML=html;
}

function draw(){
    ctx.fillStyle='#ffffff';
    ctx.fillRect(0,0,window.innerWidth,window.innerHeight-42);
    const now=new Date();
    const monday=new Date(Date.UTC(now.getUTCFullYear(),now.getUTCMonth(),now.getUTCDate()-(now.getUTCDay()===0?6:now.getUTCDay()-1),0,0,0));
    
    ctx.save();
    ctx.translate(MARGIN_LEFT-cameraX,0);
    
    // FEATURE 2: Identify "Before Live" Column
    const beforeLiveCol = currentColumn > 0 ? currentColumn - 1 : -1;
    
    for(let a=Math.max(0,Math.floor(cameraX/CELL_W));a<=Math.min(MAX_COLS-1,Math.floor((cameraX+window.innerWidth)/CELL_W)+1);a++){
        let x=a*CELL_W;
        if(matrixData[a]){
            for(let s in matrixData[a]){
                const d=matrixData[a][s];
                const row = parseInt(s);
                const textX = x+CELL_W/2;
                const textY = row*CELL_H+CELL_H/2;

                ctx.save();
                // FEATURE 2: Apply scale heartbeat pulse to the column before live
                if(a === beforeLiveCol && d.s > 1) {
                    const beat = 1.0 + (0.18 * Math.abs(Math.sin(Date.now() / 150)));
                    ctx.translate(textX, textY);
                    ctx.scale(beat, beat);
                    ctx.translate(-textX, -textY);
                }

                ctx.fillStyle=d.c==='G'?'#10b981':'#ef4444';
                ctx.font='700 9px ui-monospace,monospace';
                ctx.textAlign='center';
                ctx.textBaseline='middle';
                ctx.fillText('x'+d.s, textX, textY);
                ctx.restore();
            }
        }
        // X-Axis Labels
        ctx.fillStyle='#1f2937';
        ctx.font='700 7px ui-monospace,monospace';
        ctx.textAlign='center';
        ctx.fillText(pad(a,5),x+CELL_W/2,TOTAL_ROWS*CELL_H+2);
        const localDate=new Date(monday.getTime()+(a*30000));
        ctx.font='500 6px ui-monospace,monospace';
        ctx.fillStyle='#6b7280';
        ctx.fillText(`${pad(localDate.getHours())}:${pad(localDate.getMinutes())}`,x+CELL_W/2,TOTAL_ROWS*CELL_H+11);
    }
    ctx.restore();

    // FEATURE 1: Side Index Pulsing (Canvas Rendering)
    ctx.save();
    for(let row=0;row<TOTAL_ROWS;row++){
        const isPulsing = pulsingRows.has(row);
        if(isPulsing) {
            const glow = 0.5 + 0.5 * Math.abs(Math.sin(Date.now() / 200));
            ctx.fillStyle = `rgba(59, 130, 246, ${0.4 + glow})`;
            ctx.font = '900 9px ui-monospace,monospace';
        } else {
            ctx.fillStyle='#1f2937';
            ctx.font='700 8px ui-monospace,monospace';
        }
        ctx.textAlign='center';
        ctx.fillText(pad(row,2), MARGIN_LEFT/2, row*CELL_H+CELL_H/2);
    }
    ctx.restore();

    requestAnimationFrame(draw);
}

// ... [Keep existing event listeners for dragging/modal] ...
canvas.addEventListener('mousedown',e=>{isDragging=true;lastMouseX=e.clientX;isFollowing=false;document.getElementById('followBtn').classList.remove('active');});
window.addEventListener('mousemove',e=>{if(isDragging){cameraX-=(e.clientX-lastMouseX);cameraX=Math.max(0,cameraX);lastMouseX=e.clientX;}});
window.addEventListener('mouseup',()=>isDragging=false);
window.closeModal=()=>{document.getElementById('modal').classList.remove('show');document.getElementById('modalOverlay').classList.remove('show');}
window.openModal=(sec)=>{
    document.getElementById('modalTitle').innerText=`${pad(sec,2)} ANOMALY HISTORY`;
    document.getElementById('modalDualContent').style.display='flex';
    document.getElementById('modalSingleContent').style.display='none';
    let rS=[],gS=[];
    Object.values(matrixData).forEach(m=>{if(m[sec]){(m[sec].c==='R'?rS:gS).push(m[sec].s);}});
    const getSum=(arr)=>{
        const c={}; arr.forEach(s=>c[s]=(c[s]||0)+1);
        return Object.keys(c).map(s=>({s:parseInt(s),c:c[s]})).sort((a,b)=>b.s-a.s);
    };
    document.getElementById('rD').innerHTML=getSum(rS).map(i=>`<div style="padding:5px;border-bottom:1px solid var(--grid);text-align:center;color:var(--red)">X${pad(i.s,2)} (${i.c})</div>`).join('');
    document.getElementById('gD').innerHTML=getSum(gS).map(i=>`<div style="padding:5px;border-bottom:1px solid var(--grid);text-align:center;color:var(--green)">X${pad(i.s,2)} (${i.c})</div>`).join('');
    document.getElementById('modal').classList.add('show');
    document.getElementById('modalOverlay').classList.add('show');
}
window.openReversalModal=(k,r,c)=>{
    document.getElementById('modalTitle').innerText=`${c.toUpperCase()} ${k}`;
    document.getElementById('modalTitle').style.color=c==='red'?'var(--red)':'var(--green)';
    document.getElementById('modalDualContent').style.display='none';
    document.getElementById('modalSingleContent').style.display='flex';
    document.getElementById('modalSingleContent').innerHTML=r.map(row=>`<div style="color:var(--text)">${pad(row.row,2)}</div>`).join('');
    document.getElementById('modal').classList.add('show');
    document.getElementById('modalOverlay').classList.add('show');
}
document.getElementById('followBtn').onclick=function(){isFollowing=!isFollowing;this.classList.toggle('active',isFollowing);if(isFollowing)jumpToCurrent();};
window.onresize=resize;
(async function init(){await loadFirebaseData();resize();connectDerivWS();draw();})();
</script>
