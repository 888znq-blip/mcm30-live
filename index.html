<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no">
<title>MCM(30) CORE DNA [CLOUD MASTER]</title>
<style>
/* EXACT STYLES FROM ORIGINAL 30.HTML */
:root {
    --bg:    #000000; 
    --grid:  #222222; 
    --meta:  #888888;
    --red:   #FF0000; 
    --green: #00FF00; 
    --blue:  #3b82f6;
    --header-h: 40px; 
    --panel-w-streak: 64px;   
    --panel-w-index: 36px;    
    --panel-w-reversal: 120px; 
    --total-right-margin: 220px; 
}
* { margin: 0; padding: 0; box-sizing: border-box; }
::-webkit-scrollbar { display: none; }
body, html {
    background-color: var(--bg);
    width: 100vw; height: 100vh;
    overflow: hidden; font-family: Consolas, monospace;
    touch-action: none; color: var(--red);
}
#ui {
    position: fixed; top: 0; left: 0; width: 100%; height: var(--header-h);
    background-color: var(--bg); border-bottom: 1px solid var(--grid);
    display: flex; align-items: center; justify-content: space-between;
    padding: 0 16px; z-index: 1000;
}
h1 { font-size: 14px; color: var(--green); letter-spacing: 2px; font-weight: 900; }
#status { font-size: 11px; font-weight: 900; color: var(--red); border: 1px solid var(--grid); padding: 4px 8px; }

canvas { display: block; margin-top: var(--header-h); cursor: crosshair; }

#panelsContainer {
    position: fixed; right: 0; top: var(--header-h); height: calc(100vh - var(--header-h));
    width: var(--total-right-margin); display: flex; background-color: var(--bg); border-left: 1px solid var(--grid); z-index: 999;
}
.panel { height: 100%; display: flex; flex-direction: column; overflow: hidden; border-left: 1px solid var(--grid); }
#streakPanel { width: var(--panel-w-streak); border-left: none; }
#indexPanel { width: var(--panel-w-index); }
#reversalPanel { width: var(--panel-w-reversal); }

.streak-row, .reversal-row { display: flex; width: 100%; border-bottom: 1px solid var(--grid); cursor: pointer; flex-shrink: 0; }
.streak-col, .reversal-col { flex: 1; display: flex; align-items: center; justify-content: center; font-size: 10px; font-weight: 700; padding: 1px 0; line-height: 1; }
.red-side { color: var(--red); border-right: 1px solid var(--grid); }
.green-side { color: var(--green); }

.index-cell { width: 100%; display: flex; align-items: center; justify-content: center; font-size: 10px; font-weight: 900; color: var(--meta); border-bottom: 1px solid var(--grid); flex-shrink: 0; transition: all 0.3s; }
.index-cell.pulsing { background-color: var(--blue); color: #fff; animation: pulseAnom 0.8s infinite alternate; }
@keyframes pulseAnom { from { opacity: 1; } to { opacity: 0.4; } }

/* MODAL STYLES PRESERVED FROM ORIGINAL */
#modalOverlay { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); z-index: 1999; }
#modal { 
    display: none; position: fixed; top: 50%; left: 50%; transform: translate(-50%,-50%); 
    width: 220px; max-height: 80vh; background: var(--bg); border: 1px solid var(--grid); 
    z-index: 2000; padding: 15px; flex-direction: column; 
}
#modal.show, #modalOverlay.show { display: flex; }
#modalTitle { text-align: center; font-weight: 900; margin-bottom: 10px; font-size: 12px; }
#modalSingleContent { display: none; flex-wrap: wrap; gap: 4px; justify-content: center; padding: 5px; }
#modalDualContent { display: flex; gap: 5px; }
.modal-col-box { flex: 1; border: 1px solid var(--grid); }
.modal-col-header { text-align: center; font-size: 10px; border-bottom: 1px solid var(--grid); padding: 4px; font-weight: 900; }
</style>
</head>
<body>

<div id="ui">
    <div style="display:flex; gap:15px; align-items:center;">
        <h1>MCM(30) MASTER</h1>
        <div id="status">OFFLINE</div>
    </div>
    <div style="display:flex; gap:10px;">
        <button id="resetBtn" style="background:#300; color:#F00; border:1px solid #F00; padding:4px 8px; font-size:10px; font-weight:900; cursor:pointer;">HARD RESET</button>
        <button id="followBtn" style="background:var(--grid); color:#FFF; border:none; padding:4px 8px; font-size:10px; font-weight:900; cursor:pointer;">FOLLOWING</button>
    </div>
</div>

<canvas id="matrixCanvas"></canvas>

<div id="panelsContainer">
    <div id="streakPanel" class="panel"></div>
    <div id="indexPanel" class="panel"></div>
    <div id="reversalPanel" class="panel"></div>
</div>

<div id="modalOverlay" onclick="closeModal()"></div>
<div id="modal">
    <div id="modalTitle"></div>
    <div id="modalSingleContent"></div>
    <div id="modalDualContent">
        <div class="modal-col-box"><div class="modal-col-header" style="color:var(--red)">RED</div><div id="rD"></div></div>
        <div class="modal-col-box"><div class="modal-col-header" style="color:var(--green)">GRN</div><div id="gD"></div></div>
    </div>
</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
import { getDatabase, ref, get } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";

const firebaseConfig = {
    apiKey: "AIzaSyDrvNy94Jhq8RmYM7jgfckrxneCetVkYw4",
    authDomain: "mcm30-db-fe9da.firebaseapp.com",
    databaseURL: "https://mcm30-db-fe9da-default-rtdb.asia-southeast1.firebasedatabase.app",
    projectId: "mcm30-db-fe9da",
    storageBucket: "mcm30-db-fe9da.firebasestorage.app",
    messagingSenderId: "34034835036",
    appId: "1:34034835036:web:3e5dcd7e6b5c2c21e15099"
};

const app = initializeApp(firebaseConfig);
const db_cloud = getDatabase(app);

const canvas = document.getElementById('matrixCanvas');
const ctx = canvas.getContext('2d', { alpha: false, desynchronized: true });
const statusEl = document.getElementById('status');

// CORE LOGIC CONSTANTS FROM 30.HTML
let currentColumn = 0, ticksInCurrentMinute = 0, matrixData = {}, tickHistory = [];
let cameraX = 0, isFollowing = true, isDragging = false, lastMouseX = 0;
let pulsingRows = new Set();

const TOTAL_ROWS = 30, MCM_LOOKBACK = 30, MAX_COLS = 14400, CELL_W = 32;
let CELL_H = 12;
const MARGIN_LEFT = 35, MARGIN_RIGHT = 220;

const noPad = (n) => String(n).padStart(2, '0');

// PULSING / ANOMALY LOGIC
function detectAnomalies() {
    pulsingRows.clear();
    let patterns = [];
    for (let r = 0; r < TOTAL_ROWS; r++) {
        let rS = {}, gS = {};
        Object.values(matrixData).forEach(col => {
            const d = col[r];
            if(d) { (d.c==='R'?rS:gS)[d.s] = ((d.c==='R'?rS:gS)[d.s] || 0) + 1; }
        });
        ['R','G'].forEach((c, idx) => {
            const map = idx === 0 ? rS : gS;
            Object.keys(map).forEach(s => {
                let str = parseInt(s), freq = map[s];
                patterns.push({ row: r, streak: str, score: str * (100/freq), color: c });
            });
        });
    }
    patterns.sort((a,b)=>b.score-a.score).slice(0,8).forEach(p => {
        const live = matrixData[currentColumn]?.[p.row];
        if(live && ((live.c !== p.color && live.s >= p.streak-2) || (live.c === p.color && live.s >= p.streak-1))) {
            pulsingRows.add(p.row);
        }
    });
}

function handleTick(tick) {
    const price = tick.quote;
    tickHistory.push({ price });
    if (!matrixData[currentColumn]) matrixData[currentColumn] = {};
    const row = Math.min(ticksInCurrentMinute, TOTAL_ROWS - 1);
    
    let color = 'G';
    if (tickHistory.length > MCM_LOOKBACK) {
        const oldP = tickHistory[tickHistory.length - (MCM_LOOKBACK + 1)].price;
        color = price > oldP ? 'G' : (price < oldP ? 'R' : 'G');
    }

    const prev = (currentColumn > 0) ? matrixData[currentColumn - 1]?.[row] : null;
    matrixData[currentColumn][row] = { c: color, s: (prev && prev.c === color) ? prev.s + 1 : 1 };

    ticksInCurrentMinute++;
    if (ticksInCurrentMinute >= TOTAL_ROWS) {
        currentColumn++;
        ticksInCurrentMinute = 0;
    }
}

async function loadCloudData() {
    statusEl.innerText = "DB SYNC...";
    const snapshot = await get(ref(db_cloud, 'tick_history'));
    if (snapshot.exists() && snapshot.val().prices) {
        matrixData = {}; currentColumn = 0; ticksInCurrentMinute = 0; tickHistory = [];
        snapshot.val().prices.forEach(p => handleTick({ quote: p }));
        statusEl.innerText = "LIVE";
        refreshUI();
    }
}

function refreshUI() {
    detectAnomalies();
    updateStreakPanel();
    updateReversalPanel();
    if (isFollowing) jumpToCurrent();
}

function draw() {
    ctx.fillStyle = '#000';
    ctx.fillRect(0, 0, canvas.width, canvas.height);
    
    const beforeLiveCol = currentColumn > 0 ? currentColumn - 1 : -1;
    ctx.save();
    ctx.translate(MARGIN_LEFT - cameraX, 0);

    const startVis = Math.max(0, Math.floor(cameraX / CELL_W));
    const endVis = Math.min(currentColumn, Math.floor((cameraX + window.innerWidth) / CELL_W) + 1);

    for (let a = startVis; a <= endVis; a++) {
        if (!matrixData[a]) continue;
        for (let r in matrixData[a]) {
            const d = matrixData[a][r];
            const tx = a * CELL_W + CELL_W/2, ty = r * CELL_H + CELL_H/2;
            ctx.save();
            if(a === beforeLiveCol && d.s > 1) {
                const beat = 1 + (0.15 * Math.abs(Math.sin(Date.now()/150)));
                ctx.translate(tx, ty); ctx.scale(beat, beat); ctx.translate(-tx, -ty);
            }
            ctx.fillStyle = d.c === 'G' ? '#0F0' : '#F00';
            ctx.font = 'bold 10px Consolas'; ctx.textAlign = 'center';
            ctx.fillText('x' + d.s, tx, ty + 4);
            ctx.restore();
        }
    }
    ctx.restore();

    for (let i = 0; i < TOTAL_ROWS; i++) {
        const isP = pulsingRows.has(i);
        ctx.fillStyle = isP ? '#3b82f6' : '#444';
        ctx.font = '900 10px Consolas';
        ctx.fillText(noPad(i), 5, i * CELL_H + CELL_H/2 + 4);
    }
    requestAnimationFrame(draw);
}

function updateStreakPanel() {
    let sH = '', iH = '';
    for (let r = 0; r < TOTAL_ROWS; r++) {
        let rM = 0, gM = 0;
        Object.values(matrixData).forEach(m => {
            if (m[r]) { if (m[r].c === 'R') rM = Math.max(rM, m[r].s); else gM = Math.max(gM, m[r].s); }
        });
        sH += `<div class="streak-row" style="height:${CELL_H}px" onclick="window.openStreakModal(${r})"><div class="streak-col red-side">${rM || '--'}</div><div class="streak-col green-side">${gM || '--'}</div></div>`;
        iH += `<div class="index-cell ${pulsingRows.has(r) ? 'pulsing' : ''}" style="height:${CELL_H}px">${noPad(r)}</div>`;
    }
    document.getElementById('streakPanel').innerHTML = sH;
    document.getElementById('indexPanel').innerHTML = iH;
}

function updateReversalPanel() {
    let rM = {}, gM = {};
    for (let r = 0; r < TOTAL_ROWS; r++) {
        let rS = {}, gS = {};
        Object.keys(matrixData).forEach(c => {
            const d = matrixData[c][r];
            if (d) { (d.c === 'R' ? rS : gS)[d.s] = ((d.c === 'R' ? rS : gS)[d.s] || []).concat(c); }
        });
        [{ m: rM, s: rS }, { m: gM, s: gS }].forEach(cfg => {
            const nums = Object.keys(cfg.s).map(Number).sort((a, b) => b - a);
            if (nums.length > 0) {
                const b = nums[0], f = cfg.s[b].length, k = `X${noPad(b)}-${noPad(f)}T`;
                if (!cfg.m[k]) cfg.m[k] = { b, f, rows: [], score: b * (100 / f) };
                cfg.m[k].rows.push({ row: r });
            }
        });
    }
    const rE = Object.keys(rM).map(k => ({ k, d: rM[k] })).sort((a, b) => b.d.score - a.d.score);
    const gE = Object.keys(gM).map(k => ({ k, d: gM[k] })).sort((a, b) => b.d.score - a.d.score);
    let h = '';
    for (let i = 0; i < Math.max(rE.length, gE.length); i++) {
        h += `<div class="reversal-row" style="height:${CELL_H}px">`;
        [{ e: rE[i], c: 'red' }, { e: gE[i], c: 'green' }].forEach(sd => {
            if (sd.e) h += `<div class="reversal-col ${sd.c}-side" onclick='window.openReversalModal("${sd.e.k}",${JSON.stringify(sd.e.d.rows)},"${sd.c}")'>${sd.e.k}</div>`;
            else h += `<div class="reversal-col ${sd.c}-side">--</div>`;
        });
        h += `</div>`;
    }
    document.getElementById('reversalPanel').innerHTML = h;
}

// MODAL LOGIC PRESERVED FROM 30.HTML
window.openStreakModal = (r) => {
    document.getElementById('modalTitle').innerText = `ROW ${noPad(r)} INFO`;
    document.getElementById('modalDualContent').style.display = 'flex';
    document.getElementById('modalSingleContent').style.display = 'none';
    let rS = [], gS = [];
    Object.values(matrixData).forEach(m => { if(m[r]) (m[r].c==='R'?rS:gS).push(m[r].s); });
    const fmt = (arr, col) => {
        let c = {}; arr.forEach(x => c[x] = (c[x]||0)+1);
        return Object.keys(c).sort((a,b)=>b-a).map(k => `<div style="font-size:10px; padding:4px; text-align:center; border-bottom:1px solid var(--grid); color:${col}">X${noPad(k)} (${c[k]})</div>`).join('');
    };
    document.getElementById('rD').innerHTML = fmt(rS, 'var(--red)');
    document.getElementById('gD').innerHTML = fmt(gS, 'var(--green)');
    document.getElementById('modal').classList.add('show'); document.getElementById('modalOverlay').classList.add('show');
};

window.openReversalModal = (t, rows, c) => {
    const col = c === 'red' ? 'var(--red)' : 'var(--green)';
    document.getElementById('modalTitle').innerText = `${c.toUpperCase()} ${t}`;
    document.getElementById('modalTitle').style.color = col;
    document.getElementById('modalDualContent').style.display = 'none';
    document.getElementById('modalSingleContent').style.display = 'flex';
    document.getElementById('modalSingleContent').style.border = `1px solid ${col}`;
    document.getElementById('modalSingleContent').innerHTML = rows.map(r => `<div style="color:${col}; border:1px solid ${col}; padding:2px; font-size:10px;">${noPad(r.row)}</div>`).join('');
    document.getElementById('modal').classList.add('show'); document.getElementById('modalOverlay').classList.add('show');
};

window.closeModal = () => { document.getElementById('modal').classList.remove('show'); document.getElementById('modalOverlay').classList.remove('show'); };

// HARD RESET VIA RENDER
document.getElementById('resetBtn').onclick = async function() {
    if (confirm("HARD RESET: Wipe Cloud and start from NOW?")) {
        this.innerText = "WIPING...";
        try {
            const RENDER_URL = "https://mcm-server-qv29.onrender.com/reset-cloud";
            const res = await fetch(RENDER_URL);
            if (res.ok) { alert("Success. Reloading..."); location.reload(); }
        } catch (e) { alert("Error connecting to server."); this.innerText = "HARD RESET"; }
    }
};

// INITIALIZE
const ws = new WebSocket("wss://ws.derivws.com/websockets/v3?app_id=1089");
ws.onopen = () => ws.send(JSON.stringify({ authorize: "TpVIBWpqet5X8AH" }));
ws.onmessage = (msg) => {
    const data = JSON.parse(msg.data);
    if (data.tick) { handleTick(data.tick); refreshUI(); }
    else if (data.authorize) ws.send(JSON.stringify({ ticks: "frxEURUSD", subscribe: 1 }));
};

const jumpToCurrent = () => cameraX = Math.max(0, (currentColumn * CELL_W) - (window.innerWidth - MARGIN_RIGHT - MARGIN_LEFT) + CELL_W);

window.onresize = () => {
    const dpr = window.devicePixelRatio || 1;
    canvas.width = (window.innerWidth - 220) * dpr; canvas.height = (window.innerHeight - 40) * dpr;
    ctx.scale(dpr, dpr); CELL_H = (window.innerHeight - 40) / TOTAL_ROWS;
};

(async () => { window.onresize(); await loadCloudData(); draw(); })();
</script>
</body>
</html>
