<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no">
<title>MCM(30) CORE [CLOUD SYNC]</title>
<style>
/* ALL ORIGINAL CSS PRESERVED */
:root {
    --bg:    #000000; 
    --grid:  #222222; 
    --meta:  #888888;
    --red:   #FF0000; 
    --green: #00FF00; 
    --header-h: 40px; 
    --panel-w-streak: 64px;   
    --panel-w-index: 36px;    
    --panel-w-reversal: 120px; 
    --total-right-margin: 220px; 
}
* { margin: 0; padding: 0; box-sizing: border-box; }
::-webkit-scrollbar { display: none; }
* { -ms-overflow-style: none; scrollbar-width: none; }
body, html {
    background-color: var(--bg);
    width: 100vw;
    height: 100vh;
    overflow: hidden;
    font-family: Consolas, monospace;
    touch-action: none;
    color: var(--red);
}
#ui {
    position: fixed; top: 0; left: 0; width: 100%; height: var(--header-h);
    background-color: var(--bg); border-bottom: 1px solid var(--grid);
    display: flex; align-items: center; justify-content: space-between;
    padding: 0 16px; z-index: 1000;
}
h1 { font-size: 14px; color: var(--green); letter-spacing: 2px; font-weight: 900; }
#status { font-size: 11px; font-weight: 900; color: var(--red); border: 1px solid var(--grid); padding: 4px 8px; }
canvas { display: block; margin-top: var(--header-h); width: 100%; height: calc(100vh - var(--header-h)); cursor: crosshair; }
#panelsContainer {
    position: fixed; right: 0; top: var(--header-h); height: calc(100vh - var(--header-h));
    width: var(--total-right-margin); display: flex; background-color: var(--bg); border-left: 1px solid var(--grid); z-index: 999;
}
.panel { height: 100%; display: flex; flex-direction: column; overflow: hidden; border-left: 1px solid var(--grid); }
#streakPanel { width: var(--panel-w-streak); border-left: none; }
#indexPanel { width: var(--panel-w-index); }
#reversalPanel { width: var(--panel-w-reversal); }
.streak-row, .reversal-row { display: flex; width: 100%; border-bottom: 1px solid var(--grid); cursor: pointer; flex-shrink: 0; }
.streak-col, .reversal-col { flex: 1; display: flex; align-items: center; justify-content: center; font-size: 10px; font-weight: 700; padding: 1px 0; line-height: 1; }
.red-side { color: var(--red); border-right: 1px solid var(--grid); }
.green-side { color: var(--green); }
.index-cell { width: 100%; display: flex; align-items: center; justify-content: center; font-size: 10px; font-weight: 900; color: var(--meta); border-bottom: 1px solid var(--grid); flex-shrink: 0; }
#modalOverlay { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); z-index: 1999; }
#modal { display: none; position: fixed; top: 50%; left: 50%; transform: translate(-50%,-50%); width: 200px; max-height: 80vh; background: var(--bg); border: 1px solid var(--grid); z-index: 2000; padding: 15px; flex-direction: column; }
#modal.show, #modalOverlay.show { display: flex; }
#modalTitle { text-align: center; font-weight: 900; font-size: 12px; margin-bottom: 10px; border-bottom: 1px solid var(--grid); padding-bottom: 5px; }
.modal-content { display: flex; gap: 5px; flex: 1; overflow: hidden; }
.modal-column { flex: 1; display: flex; flex-direction: column; border: 1px solid var(--grid); overflow: hidden; }
.modal-column-header { padding: 5px; text-align: center; font-weight: 900; font-size: 10px; border-bottom: 1px solid var(--grid); }
.modal-column-content { flex: 1; overflow-y: auto; display: flex; flex-direction: column; }
#modalSingleContent { display: none; flex-wrap: wrap; gap: 4px; justify-content: center; padding: 10px; max-height: 60vh; overflow-y: auto; }
#modalSingleContent div { padding: 4px; font-size: 10px; font-weight: 900; text-align: center; width: 30px; }
</style>
</head>
<body>

<div id="ui">
    <div style="display:flex; gap:15px; align-items:center;">
        <h1>MCM(30) CORE</h1>
        <div id="status">OFFLINE</div>
    </div>
    <div style="display:flex; gap:10px;">
        <button id="followBtn" style="background:var(--grid); color:#FFF; border:none; padding:5px 10px; font-size:10px; font-weight:900; cursor:pointer;">FOLLOWING</button>
        <button onclick="location.reload()" style="background:var(--bg); color:var(--meta); border:1px solid var(--grid); padding:5px 10px; font-size:10px; font-weight:900; cursor:pointer;">REFRESH</button>
    </div>
</div>

<canvas id="matrixCanvas"></canvas>

<div id="panelsContainer">
    <div id="streakPanel" class="panel"></div>
    <div id="indexPanel" class="panel"></div>
    <div id="reversalPanel" class="panel"></div>
</div>

<div id="modalOverlay" onclick="closeModal()"></div>
<div id="modal">
    <div id="modalTitle"></div>
    <div id="modalSingleContent"></div>
    <div class="modal-content" id="modalDualContent">
        <div class="modal-column"><div class="modal-column-header" style="color:var(--red)">RED</div><div class="modal-column-content" id="rD"></div></div>
        <div class="modal-column"><div class="modal-column-header" style="color:var(--green)">GRN</div><div class="modal-column-content" id="gD"></div></div>
    </div>
</div>

<script type="module">
// --- ADDED CLOUD CONFIGS ---
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
import { getDatabase, ref, get } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";

const firebaseConfig = {
  apiKey: "AIzaSyDrvNy94Jhq8RmYM7jgfckrxneCetVkYw4",
  authDomain: "mcm30-db-fe9da.firebaseapp.com",
  databaseURL: "https://mcm30-db-fe9da-default-rtdb.asia-southeast1.firebasedatabase.app",
  projectId: "mcm30-db-fe9da",
  storageBucket: "mcm30-db-fe9da.firebasestorage.app",
  messagingSenderId: "34034835036",
  appId: "1:34034835036:web:3e5dcd7e6b5c2c21e15099"
};

const app = initializeApp(firebaseConfig);
const db_cloud = getDatabase(app);

// --- ALL ORIGINAL LOGIC PRESERVED ---
const canvas = document.getElementById('matrixCanvas');
const ctx = canvas.getContext('2d', { alpha: false, desynchronized: true });
const statusEl = document.getElementById('status');
const SYMBOL = "frxEURUSD";
const TOKEN = "TpVIBWpqet5X8AH";
const DERIV_WS = "wss://ws.derivws.com/websockets/v3?app_id=1089";

let currentColumn = 0, ticksInCurrentMinute = 0, matrixData = {}, tickHistory = [];
let cameraX = 0, isFollowing = true, lastPrice = null, isDragging = false, lastMouseX = 0;

const TOTAL_ROWS = 30, MCM_LOOKBACK = 30, MAX_COLS = 14400, CELL_W = 32;
let CELL_H = 12;
const MARGIN_LEFT = 35, MARGIN_RIGHT = 220, MARGIN_BOTTOM = 0;

const pad = (n) => String(n).padStart(2, '0');
const noPad = (n) => String(n);

function handleTick(tick) {
    const price = tick.quote;
    tickHistory.push({ price });
    if (!matrixData[currentColumn]) matrixData[currentColumn] = {};
    const row = Math.min(ticksInCurrentMinute, TOTAL_ROWS - 1);
    
    let color = 'G';
    if (tickHistory.length > MCM_LOOKBACK) {
        const oldP = tickHistory[tickHistory.length - (MCM_LOOKBACK + 1)].price;
        if (price > oldP) color = 'G';
        else if (price < oldP) color = 'R';
        else color = 'G';
    }

    if (currentColumn > 0 && matrixData[currentColumn - 1] && matrixData[currentColumn - 1][row]) {
        const prev = matrixData[currentColumn - 1][row];
        matrixData[currentColumn][row] = { c: color, s: prev.c === color ? prev.s + 1 : 1 };
    } else {
        matrixData[currentColumn][row] = { c: color, s: 1 };
    }

    ticksInCurrentMinute++;
    if (ticksInCurrentMinute >= TOTAL_ROWS) {
        currentColumn++;
        if (currentColumn >= MAX_COLS) currentColumn = 0;
        ticksInCurrentMinute = 0;
    }
}

// --- CLOUD SYNC LOADER ---
async function loadCloudData() {
    statusEl.innerText = "LOADING...";
    try {
        const snapshot = await get(ref(db_cloud, 'tick_history'));
        if (snapshot.exists()) {
            const data = snapshot.val();
            if (data.prices) {
                // Clear local and rebuild from Cloud
                matrixData = {}; currentColumn = 0; ticksInCurrentMinute = 0; tickHistory = [];
                data.prices.forEach(p => handleTick({ quote: p }));
                statusEl.innerText = "LIVE";
                updateStreakPanel(); updateReversalPanel();
                if (isFollowing) jumpToCurrent();
            }
        }
    } catch (e) { statusEl.innerText = "SYNC ERR"; }
}

function connectWS() {
    const ws = new WebSocket(DERIV_WS);
    ws.onopen = () => ws.send(JSON.stringify({ authorize: TOKEN }));
    ws.onmessage = (msg) => {
        const data = JSON.parse(msg.data);
        if (data.authorize) { statusEl.innerText = "LIVE"; ws.send(JSON.stringify({ ticks: SYMBOL, subscribe: 1 })); }
        if (data.tick) {
            handleTick(data.tick);
            updateStreakPanel();
            updateReversalPanel();
            if (isFollowing) jumpToCurrent();
        }
    };
    ws.onclose = () => setTimeout(connectWS, 3000);
}

function resize() {
    const dpr = window.devicePixelRatio || 1;
    canvas.width = window.innerWidth * dpr;
    canvas.height = (window.innerHeight - 40) * dpr;
    ctx.scale(dpr, dpr);
    CELL_H = (window.innerHeight - 40) / TOTAL_ROWS;
    if (isFollowing) jumpToCurrent();
}

function jumpToCurrent() {
    const totalW = currentColumn * CELL_W;
    const viewW = window.innerWidth - MARGIN_RIGHT - MARGIN_LEFT;
    cameraX = Math.max(0, totalW - viewW + CELL_W);
}

function draw() {
    ctx.fillStyle = '#000';
    ctx.fillRect(0, 0, canvas.width, canvas.height);
    ctx.save();
    ctx.translate(MARGIN_LEFT - cameraX, 0);
    
    const startVisible = Math.max(0, Math.floor(cameraX / CELL_W));
    const endVisible = Math.min(currentColumn, Math.floor((cameraX + window.innerWidth) / CELL_W) + 1);

    for (let a = startVisible; a <= endVisible; a++) {
        if (!matrixData[a]) continue;
        let x = a * CELL_W;
        for (let r in matrixData[a]) {
            const d = matrixData[a][r];
            ctx.fillStyle = d.c === 'G' ? '#00FF00' : '#FF0000';
            ctx.font = 'bold 10px Consolas';
            ctx.textAlign = 'center';
            ctx.fillText('x' + d.s, x + CELL_W / 2, r * CELL_H + CELL_H / 2 + 4);
        }
    }
    ctx.restore();

    // Side Index
    for (let i = 0; i < TOTAL_ROWS; i++) {
        ctx.fillStyle = '#444';
        ctx.font = '900 10px Consolas';
        ctx.fillText(pad(i), 5, i * CELL_H + CELL_H / 2 + 4);
    }
    requestAnimationFrame(draw);
}

// UI UPDATE LOGIC (ORIGINAL)
function updateStreakPanel() {
    const p = document.getElementById('streakPanel');
    const idx = document.getElementById('indexPanel');
    let h = '', iH = '';
    for (let s = 0; s < TOTAL_ROWS; s++) {
        let rM = 0, gM = 0;
        Object.values(matrixData).forEach(m => {
            if (m[s]) { if (m[s].c === 'R') rM = Math.max(rM, m[s].s); else gM = Math.max(gM, m[s].s); }
        });
        h += `<div class="streak-row" onclick="window.openModal(${s})" style="height:${CELL_H}px"><div class="streak-col red-side">${rM || '--'}</div><div class="streak-col green-side">${gM || '--'}</div></div>`;
        iH += `<div class="index-cell" style="height:${CELL_H}px">${pad(s)}</div>`;
    }
    p.innerHTML = h; idx.innerHTML = iH;
}

function updateReversalPanel() {
    const p = document.getElementById('reversalPanel');
    let rM = {}, gM = {};
    for (let r = 0; r < TOTAL_ROWS; r++) {
        let rS = {}, gS = {};
        Object.keys(matrixData).forEach(c => {
            const d = matrixData[c][r];
            if (d) { (d.c === 'R' ? rS : gS)[d.s] = ((d.c === 'R' ? rS : gS)[d.s] || []).concat(c); }
        });
        [{ m: rM, s: rS }, { m: gM, s: gS }].forEach(cfg => {
            const nums = Object.keys(cfg.s).map(Number).sort((a, b) => b - a);
            if (nums.length > 0) {
                const b = nums[0], f = cfg.s[b].length, k = `X${pad(b)}-${pad(f)}T`;
                if (!cfg.m[k]) cfg.m[k] = { b, f, rows: [], score: b * (100 / f) };
                cfg.m[k].rows.push({ row: r });
            }
        });
    }
    const rE = Object.keys(rM).map(k => ({ k, d: rM[k] })).sort((a, b) => b.d.score - a.d.score);
    const gE = Object.keys(gM).map(k => ({ k, d: gM[k] })).sort((a, b) => b.d.score - a.d.score);
    let h = '';
    for (let i = 0; i < Math.max(rE.length, gE.length); i++) {
        h += `<div class="reversal-row" style="height:${CELL_H}px">`;
        [{ e: rE[i], c: 'red' }, { e: gE[i], c: 'green' }].forEach(sd => {
            if (sd.e) h += `<div class="reversal-col ${sd.c}-side" onclick='window.openReversalModal("${sd.e.k}",${JSON.stringify(sd.e.d.rows)},"${sd.c}")'>${sd.e.k}</div>`;
            else h += `<div class="reversal-col ${sd.c}-side">--</div>`;
        });
        h += `</div>`;
    }
    p.innerHTML = h;
}

// MODALS AND INTERACTION (ORIGINAL)
window.openModal = (s) => {
    document.getElementById('modalTitle').innerText = `${pad(s)} ANOMALY`;
    document.getElementById('modalDualContent').style.display = 'flex';
    document.getElementById('modalSingleContent').style.display = 'none';
    let rS = [], gS = [];
    Object.values(matrixData).forEach(m => { if (m[s]) (m[s].c === 'R' ? rS : gS).push(m[s].s); });
    const getSum = (arr) => {
        const c = {}; arr.forEach(x => c[x] = (c[x] || 0) + 1);
        return Object.keys(c).map(x => ({ s: parseInt(x), c: c[x] })).sort((a, b) => b.s - a.s);
    };
    document.getElementById('rD').innerHTML = getSum(rS).map(i => `<div style="padding:5px;border-bottom:1px solid var(--grid);text-align:center;color:var(--red);font-size:10px;">X${pad(i.s)} (${i.c})</div>`).join('');
    document.getElementById('gD').innerHTML = getSum(gS).map(i => `<div style="padding:5px;border-bottom:1px solid var(--grid);text-align:center;color:var(--green);font-size:10px;">X${pad(i.s)} (${i.c})</div>`).join('');
    document.getElementById('modal').classList.add('show'); document.getElementById('modalOverlay').classList.add('show');
};

window.openReversalModal = (t, rows, c) => {
    const col = c === 'red' ? 'var(--red)' : 'var(--green)';
    document.getElementById('modalTitle').innerText = `${c.toUpperCase()} ${t}`;
    document.getElementById('modalTitle').style.color = col;
    document.getElementById('modalDualContent').style.display = 'none';
    document.getElementById('modalSingleContent').style.display = 'flex';
    document.getElementById('modalSingleContent').innerHTML = rows.map(r => `<div style="color:${col};border:1px solid var(--grid)">${noPad(r.row)}</div>`).join('');
    document.getElementById('modal').classList.add('show'); document.getElementById('modalOverlay').classList.add('show');
};

window.closeModal = () => { document.getElementById('modal').classList.remove('show'); document.getElementById('modalOverlay').classList.remove('show'); };

canvas.addEventListener('mousedown', e => { isDragging = true; lastMouseX = e.clientX; isFollowing = false; document.getElementById('followBtn').innerText = 'FOLLOW'; });
window.addEventListener('mousemove', e => { if (isDragging) { cameraX -= (e.clientX - lastMouseX); cameraX = Math.max(0, cameraX); lastMouseX = e.clientX; } });
window.addEventListener('mouseup', () => isDragging = false);
document.getElementById('followBtn').onclick = function() { isFollowing = !isFollowing; this.innerText = isFollowing ? 'FOLLOWING' : 'FOLLOW'; if (isFollowing) jumpToCurrent(); };

window.onresize = resize;
(async function init() { resize(); await loadCloudData(); connectWS(); draw(); })();
</script>
</body>
</html>
